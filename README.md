# 호그와트 급행 시뮬레이터

Gemini API를 활용해 장면 묘사를 생성하는 웹 기반 인터랙티브 픽션입니다. 플레이어는 초대장을 받은 순간부터 정렬 모자 앞까지 일련의 사건을 겪으며 성향 점수를 쌓고, 최종적으로 기숙사 배정을 받습니다.

## 주요 특징

- **LLM 하이브리드**: 장면 진행과 점수 계산은 로컬 엔진이 담당하고, 묘사와 상호작용 제안은 Gemini가 생성합니다. API 키가 없거나 오류가 발생하면 준비된 폴백 텍스트로 진행합니다.
- **캐릭터 생성**: 이름·성별·국적·출신 배경·가족 구성과 함께 무작위 능력치(체력, 마력, 지능, 민첩, 건강, 매력)를 배정받은 뒤 여정을 시작합니다.
- **세부 성향 추적**: 현실적/이상적, 개인주의/협동적, 도전적/안정적 등 12가지 성향 지표를 Gemini가 제안한 태그로 누적해 정렬 모자 판단에 참고합니다.
- **자유 입력 상호작용**: 버튼 대신 채팅 입력으로 상황에 대응하면, Gemini가 의도를 분류해 장면을 진전시킵니다. 사용자에게는 기숙사 점수 힌트가 노출되지 않아 서사에 집중할 수 있습니다.
- **발더스 게이트식 판정 힌트**: 모든 선택지는 관련 능력과 대략적 성공률, 실패 리스크를 `hint`에 표시해 전략적 결정을 돕습니다.
- **이미지 도구 연동**: Gemini `gemini-2.5-flash-image-preview` 모델을 사용해 장면별 일러스트를 생성·보정하고, 자동 초상화 기능까지 갤러리에 곧바로 추가할 수 있습니다.
- **정렬 모자 추가 질문**: 상위 두 기숙사 점수가 비슷하면 모자가 한 번 더 질문하여 맥락에 맞게 최종 결정을 내립니다.
- **편의 기능**: 채팅 로그, 한 단계 되돌리기, 저장/불러오기, Gemini API 키 관리, 참고 이미지 업로드 등을 지원합니다.

## 사용 방법

### 사전 준비

1. 저장소 루트에서 의존성을 설치합니다.

   ```bash
   npm install
   ```

2. 설치가 완료되면 단위 테스트를 실행해 로컬 환경이 정상인지 확인할 수 있습니다.

   ```bash
   npm test
   ```

   `vitest run`이 수행되며 점수 계산, 저장/불러오기, 정렬 확률 테스트를 검증합니다.

### 실행

1. 정적 파일을 서빙할 간단한 개발 서버를 띄웁니다. 예시는 다음과 같습니다.

   ```bash
   npx http-server -p 4173
   ```

   또는 VS Code Live Server, Python `python -m http.server`, Vite Preview 등 어떤 정적 서버도 무방합니다.
2. 브라우저에서 `http://localhost:4173/index.html`을 열면 첫 화면이 나타납니다. 파일을 더블클릭해 직접 여는 방식도 대다수 최신 브라우저에서 동작하지만, 브라우저 보안 정책에 따라 정적 서버를 사용하는 것이 가장 확실합니다.
3. 첫 진입 시 캐릭터 생성 인터뷰가 열립니다. 질문에 답하거나 자유롭게 설정을 작성하면 자동으로 능력치가 부여됩니다.
4. 이후 장면은 Gemini 혹은 폴백 텍스트로 전개되며, 채팅 입력으로 상황에 대응합니다.

### 조작법

- **채팅 입력**: 하단 텍스트 영역에 자신의 행동이나 대사를 적어 Enter(또는 전송 버튼)로 제출합니다.
- **상단 툴바**: 되돌리기, 저장/불러오기, 초기화, Gemini 설정, 이미지 업로드 버튼이 배치되어 있습니다.
- **상호작용 힌트**: 대화 영역 아래에 발더스 게이트3 스타일의 판정 힌트(능력 + 성공률 + 위험)가 최대 4개까지 제시됩니다.
- **이미지 생성/업로드**: 툴바의 **이미지 생성** 버튼으로 Gemini 이미지 모델을, **이미지 업로드** 버튼으로 참고 이미지를 추가할 수 있습니다.
- **우측 패널**: 캐릭터 프로필, 무작위 능력치, 최근 주요 사건, 업로드한 이미지를 확인할 수 있으며 `캐릭터 시트 숨기기` 버튼으로 토글할 수 있습니다.

### Gemini 키 및 모델 설정

1. 우측 상단의 **Gemini 키** 버튼을 누르면 설정 모달이 열립니다.
2. 개인 API 키를 입력한 뒤, 드롭다운에서 사용할 텍스트 모델(`gemini-2.5-pro`, `gemini-2.5-flash`)을 선택합니다.
3. 저장하면 키와 모델이 로컬 스토리지에 암호화 없이 저장되며, 이후 장면부터 해당 모델로 LLM 묘사를 요청합니다.
4. 이미지 생성은 항상 `gemini-2.5-flash-image-preview` 모델을 사용하며, 키만 공유하면 됩니다.
5. 키를 비우거나 삭제하면 자동으로 폴백 내레이션을 사용하며, 모델 선택은 비활성화됩니다.

### 이미지 생성

1. 툴바의 **이미지 생성** 버튼을 눌러 전용 모달을 엽니다.
2. 장면을 선택하면 기본 프롬프트와 보정 팁이 자동으로 채워집니다. 원하는 서술을 덧붙여 세부 묘사를 조정하세요.
3. 필요하면 참조 이미지를 첨부해 리터치/변형 모드로 활용합니다.
4. **이미지 생성**을 누르면 `gemini-2.5-flash-image-preview`가 이미지를 만들고, 결과는 오른쪽 갤러리에 즉시 추가됩니다.
5. 모달 하단의 **캐릭터 생성 시 자동으로 초상화를 생성** 체크박스로 자동 초상화 기능을 토글할 수 있습니다.

### 이미지 업로드

- **이미지 업로드** 버튼으로 JPG/PNG 등 이미지 파일을 선택하면 우측 패널에 미리보기가 추가됩니다.
- Gemini로 생성한 이미지도 동일한 갤러리에 함께 쌓이며, 필요 시 참조 이미지를 덮어쓸 수 있습니다.
- 필요 시 **이미지 모두 지우기** 버튼으로 업로드한 미리보기를 초기화할 수 있습니다.

### 자동 초상화

- Gemini API 키를 저장하고 자동 초상화 체크박스를 활성화하면, 캐릭터 생성이 끝나는 순간 Gemini가 캐릭터 정보를 토대로 초상화 프롬프트를 구상합니다.
- 프롬프트 생성에 실패하더라도 기본 설정으로 재시도하며, 성공 시 결과 이미지는 `캐릭터 초상` 라벨로 갤러리에 자동 추가됩니다.
- 자동 초상화는 일반 이미지 생성과 별개로 실행되며, 필요할 때 언제든 체크박스를 해제해 비활성화할 수 있습니다.

## 개발 및 실행

- 테스트는 `npm test`로 언제든 재실행할 수 있으며, 워치 모드를 사용하려면 `npx vitest`를 직접 호출하세요.
- `index.html`은 빌드 과정 없이 실행되므로 기능 수정 후 브라우저를 새로고침하면 즉시 반영됩니다.
- Gemini 키가 있다면 우측 상단 **Gemini 키** 버튼에서 입력 후 모델(`gemini-2.5-pro`, `gemini-2.5-flash`)을 선택해 실시간 묘사를 활성화하세요.

### 문제 해결

- 캐릭터 질문이 나타나지 않거나 입력란이 비활성화된 상태로 멈춘 경우, 브라우저 콘솔에 오류가 기록되었을 수 있습니다. 최신 버전에서는 오류가 발생해도 입력 창이 자동으로 재활성화되며, 상태 배너와 시스템 메시지에 재시도 안내가 출력됩니다.
- Gemini 키 입력 후에도 응답이 오지 않는다면 API 쿼터/키 권한을 확인한 뒤, 모달에서 키를 삭제하고 다시 저장해 주세요.
- 이미지 생성이 실패하면 모달 하단 상태 메시지와 상단 배너에 원인이 표시됩니다. 필요 시 참조 이미지를 제거하거나 프롬프트 길이를 줄인 뒤 다시 시도하세요.

## 테스트

```bash
npm install
npm test
```

- 점수 가중치 계산
- 저장/불러오기 직렬화
- 무작위 플레이의 기숙사 분포

## 패치 노트

### v0.5.1 (2025-09-24)

- 캐릭터 인터뷰 단계에서 예외가 발생하더라도 입력창이 즉시 복구되고 안내 메시지가 출력되도록 방어 로직을 추가했습니다.
- README에 의존성 설치, 테스트 실행, 정적 서버 실행 예시를 포함해 실행 절차를 보다 친절하게 정리했습니다.
- `npm test`가 자동으로 `vitest run`을 호출하도록 조정해 전역 설치 없이도 테스트를 한 번에 확인할 수 있습니다.

### v0.5.0 (2025-09-24)

- 자동 캐릭터 초상화를 추가해 캐릭터 생성이 끝나면 Gemini가 프로필 이미지를 제안하고 갤러리에 저장하도록 했습니다.
- 초상화용 프롬프트를 포함해 이미지 프롬프트 문서를 확장하고, README에 자동 초상화 사용법을 정리했습니다.
- 기 설정된 코드 가중치를 제거해 12가지 성향은 Gemini 태그 판단에만 의해 누적되도록 정리했습니다.

### v0.4.0 (2025-09-18)

- Gemini `gemini-2.5-flash-image-preview` 모델을 연동한 장면별 이미지 생성 모달을 추가하고, 프롬프트 가이드를 제공했습니다.
- 모든 폴백 선택지와 LLM 지침에 발더스 게이트식 판정 힌트(능력 + 성공률 + 위험)를 도입해 상호작용 자유도를 강화했습니다.
- 이미지 갤러리 UI를 개선해 생성/업로드 구분과 미리보기를 함께 관리하고, README·문서에 사용법을 보강했습니다.

### v0.3.0 (2025-09-12)

- Gemini 모델 선택을 2.5 Pro/Flash 중심으로 조정하고 기본값을 최신 모델로 교체했습니다.
- 장면 및 폴백 선택지에 12가지 성향 태그를 부여해 세밀한 성향 추적과 정렬 맥락을 강화했습니다.
- 캐릭터 시트에 성향 패널을 추가하고 LLM 컨텍스트에 등장인물 맥락 문서를 포함했습니다.

### v0.2.0 (2025-09-07)

- 캐릭터 생성 인터뷰와 무작위 능력치 부여를 추가해 여정 전 몰입감을 높였습니다.
- 선택지 버튼을 없애고 자유 입력 채팅 + Gemini 분류 방식으로 상호작용 흐름을 개편했습니다.
- 플레이어에게 노출되던 기숙사 점수 힌트를 숨기고, 캐릭터 시트는 배경·능력치·기록 위주로 재구성했습니다.
- 정렬 모자 질문 및 게임 전반에서 Gemini 응답 실패 시 안전하게 폴백이 작동하도록 UI를 정비했습니다.

### v0.1.1 (2025-09-01)

- 첫 장면이 멈춰 보이던 문제를 방지하기 위해 폴백 콘텐츠 처리 로직을 보강했습니다.
- Gemini API 키 입력 모달에 모델 선택 드롭다운을 추가하고, 선택값을 로컬에 저장하도록 개선했습니다.
- 이미지 업로드 및 미리보기 패널을 도입해 스토리 플레이 중 필요한 참고 이미지를 함께 둘 수 있게 했습니다.
- README에 실행 방법, 조작법, 설정 안내를 보강했습니다.
